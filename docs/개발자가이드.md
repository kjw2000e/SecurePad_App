# KICASecureKeypad 라이브러리 연동 가이드

앱(App)에서 `kicasecurekeypad` 라이브러리를 사용하는 방법을 안내합니다.

---

## 1. 라이브러리 추가하기 (Dependencies)

`app/build.gradle.kts` 파일에 라이브러리 의존성을 추가하세요.

```kotlin
dependencies {
    // KICA 보안 키패드 라이브러리 추가
    implementation(project(":kicasecurekeypad"))
}
```

> **참고**: `settings.gradle.kts`에 라이브러리 모듈(`:kicasecurekeypad`)이 include 되어 있어야 합니다.

---

## 2. 기본 사용법 (Basic Usage)

### 2.1. 간단한 PIN 입력 예시

```kotlin
import com.kica.android.secure.keypad.SecureKeypad
import com.kica.android.secure.keypad.domain.model.*

@Composable
fun PinInputScreen() {
    var maskedInput by remember { mutableStateOf("") }

    SecureKeypad(
        config = KeypadConfig(
            type = KeypadType.NUMERIC,
            title = "PIN 입력",
            subtitle = "6자리 숫자를 입력해주세요",
            maxLength = 6,
            enableEncryption = true
        ),
        onKeyPressed = { masked -> maskedInput = masked },
        onComplete = { encryptedValue ->
            // 서버로 암호화된 값 전송
            sendToServer(encryptedValue)
        },
        onCancel = { /* 취소 처리 */ }
    )
}
```

---

## 3. 설정 옵션 (KeypadConfig)

### 3.1. 기본 옵션

| 옵션명 | 타입 | 기본값 | 설명 |
|---|---|---|---|
| `type` | `KeypadType` | `NUMERIC` | 키패드 종류 |
| `maxLength` | `Int` | 20 | 최대 입력 길이 |
| `maskingChar` | `Char` | `*` | 마스킹 문자 (예: `●`) |
| `randomizeLayout` | `Boolean` | `true` | 숫자 키 랜덤 배열 |
| `enableEncryption` | `Boolean` | `false` | 입력값 암호화 |
| `enableHapticFeedback` | `Boolean` | `true` | 키 입력 시 진동 |
| `preventScreenCapture` | `Boolean` | `true` | 화면 캡처 방지 |

### 3.2. UI 옵션

| 옵션명 | 타입 | 기본값 | 설명 |
|---|---|---|---|
| `title` | `String?` | `null` | 상단 제목 |
| `subtitle` | `String?` | `null` | 부제목 |
| `showCancelButton` | `Boolean` | `false` | 취소 버튼 표시 |
| `cancelButtonText` | `String` | `"취소"` | 취소 버튼 텍스트 |
| `displayMode` | `KeypadDisplayMode` | `HALF` | 표시 모드 |
| `inputIndicatorStyle` | `InputIndicatorStyle` | `DOT` | 입력 인디케이터 스타일 |
| `showFixedInputSlots` | `Boolean` | `false` | 고정 슬롯 표시 (PIN용) |
| `colors` | `KeypadColors` | `default()` | 색상 테마 |

### 3.3. 입력 검증 옵션

| 옵션명 | 타입 | 기본값 | 설명 |
|---|---|---|---|
| `validation` | `InputValidation` | `InputValidation()` | 검증 규칙 |

```kotlin
// 입력 검증 예시
config = KeypadConfig(
    validation = InputValidation(
        minLength = 6,
        maxLength = 20,
        regex = "^[a-zA-Z0-9]+$",  // 영문+숫자만 허용
        customValidator = { input -> 
            if (input.contains("1234")) "연속된 숫자는 사용할 수 없습니다" else null
        }
    )
)
```

---

## 4. 표시 모드 (DisplayMode)

| 모드 | 설명 |
|------|------|
| `FULL` | 전체화면 (상단 헤더 + 하단 키패드) |
| `HALF` | 하단 시트 형태 (기본값) |
| `COMPACT` | 최소 높이 (헤더 숨김) |

```kotlin
config = KeypadConfig(
    displayMode = KeypadDisplayMode.FULL,
    title = "비밀번호 입력",
    subtitle = "영문, 숫자, 특수문자 조합 8자 이상"
)
```

---

## 5. 입력 인디케이터 스타일

| 스타일 | 설명 | 용도 |
|--------|------|------|
| `DOT` | ●●●○○○ | PIN, 간편 비밀번호 |
| `UNDERLINE` | _ _ _ | 인증번호 |
| `BOX` | [●][●][○] | OTP |
| `TEXT` | 일반 텍스트 | 금액 입력 등 |

```kotlin
config = KeypadConfig(
    inputIndicatorStyle = InputIndicatorStyle.DOT,
    showFixedInputSlots = true,  // 6칸 고정 표시
    maxLength = 6
)
```

---

## 6. 색상 테마 (KeypadColors)

### 6.1. 기본 제공 테마

```kotlin
// 라이트 테마 (기본)
KeypadColors.default()

// 다크 테마 (다크모드 시 자동 적용)
KeypadColors.dark()

// KICA 스타일
KeypadColors.kica()

// 연보라 테마
KeypadColors.lavender()
```

> **다크 모드 자동 지원**: `KeypadColors.default()` 사용 시, 시스템 다크 모드 설정에 따라 자동으로 테마가 전환됩니다.

### 6.2. 커스텀 색상

```kotlin
config = KeypadConfig(
    colors = KeypadColors(
        backgroundColor = Color(0xFFF5F7FA),
        keyBackgroundColor = Color.White,
        keyTextColor = Color(0xFF2D3748),
        specialKeyBackgroundColor = Color(0xFFE2E8F0),
        specialKeyTextColor = Color(0xFF2D3748),
        inputDisplayBackgroundColor = Color.White,
        inputDisplayTextColor = Color(0xFF1976D2),
        titleColor = Color(0xFF1976D2),
        subtitleColor = Color(0xFF4CAF50),
        cancelButtonColor = Color(0xFFFF9800)
    )
)
```

---

## 7. 키패드 타입 (KeypadType)

| 타입 | 설명 | 용도 |
|------|------|------|
| `NUMERIC` | 숫자 전용 | PIN, 계좌비밀번호 |
| `ALPHANUMERIC` | 한글/영문/숫자/특수문자 | 비밀번호, 일반 텍스트 |
| `ENGLISH` | 영문 전용 | 영문 이름 |
| `KOREAN` | 한글 전용 | 한글 이름 |

---

## 8. 콜백 이벤트

### 8.1. 기본 콜백

| 콜백 | 설명 |
|------|------|
| `onKeyPressed` | 키 입력마다 호출 (마스킹된 값 전달) |
| `onComplete` | 완료 버튼 클릭 시 호출 (입력값/암호화값 전달) |
| `onCancel` | 취소 버튼 클릭 시 호출 |
| `onError` | 에러 발생 시 호출 |

### 8.2. 확장 콜백

| 콜백 | 설명 |
|------|------|
| `onShow` | 키패드 표시 시 호출 |
| `onHide` | 키패드 사라질 때 호출 |
| `onBackspace` | 삭제 키 클릭 시 호출 |
| `onClear` | 전체 삭제 시 호출 |

```kotlin
SecureKeypad(
    config = KeypadConfig(...),
    onComplete = { value -> sendToServer(value) },
    onCancel = { navigateBack() },
    onShow = { logAnalytics("keypad_shown") },
    onHide = { logAnalytics("keypad_hidden") }
)
```

---

## 9. 암호화 (Encryption)

`enableEncryption = true` 설정 시:

1. 입력값이 AES-256으로 암호화됨
2. AES 키는 서버 RSA 공개키로 암호화
3. `onComplete`에서 받은 값은 암호화된 Hex 문자열

### 주요 암호화 흐름

```
사용자 입력 → AES-256 암호화 → 암호화 블록
AES 키 → RSA 공개키로 암호화 → 서버 전송
```

---

## 10. 메모리 보안

### 10.1. 자동 정리

- 키패드 종료 시 `clearInput()` 자동 호출
- 입력 버퍼 덮어쓰기 후 클리어

### 10.2. 수동 보안 정리

```kotlin
// ViewModel에서 직접 호출 가능
viewModel.secureClearInput()  // 모든 민감 데이터 제로화
```

---

## 11. 전체 예시 (Complete Example)

```kotlin
@Composable
fun SecurePasswordInputScreen(
    onPasswordSubmit: (String) -> Unit,
    onCancel: () -> Unit
) {
    SecureKeypad(
        modifier = Modifier.fillMaxWidth(),
        config = KeypadConfig(
            type = KeypadType.ALPHANUMERIC,
            displayMode = KeypadDisplayMode.FULL,
            title = "비밀번호 입력",
            subtitle = "영문, 숫자, 특수문자 조합 8~20자",
            showCancelButton = true,
            inputIndicatorStyle = InputIndicatorStyle.DOT,
            maxLength = 20,
            validation = InputValidation(minLength = 8),
            enableEncryption = true,
            enableHapticFeedback = true,
            preventScreenCapture = true,
            colors = KeypadColors.kica()
        ),
        onKeyPressed = { /* 마스킹 표시 업데이트 */ },
        onComplete = { encrypted -> onPasswordSubmit(encrypted) },
        onCancel = { onCancel() },
        onError = { msg -> showToast(msg) }
    )
}
```

---

## 12. FAQ

### Q: 다크 모드에서 색상이 자동으로 바뀌나요?
A: 네, `KeypadColors.default()` 사용 시 시스템 다크 모드 설정에 따라 자동 전환됩니다.

### Q: 화면 캡처가 방지되나요?
A: `preventScreenCapture = true` (기본값) 설정 시 `FLAG_SECURE`가 적용됩니다.

### Q: 한글 입력이 가능한가요?
A: `KeypadType.ALPHANUMERIC` 또는 `KeypadType.KOREAN` 사용 시 한글 조합 입력이 가능합니다.

### Q: 암호화된 값을 어떻게 복호화하나요?
A: 서버에서 RSA 개인키로 AES 키를 복호화한 후, AES 키로 데이터를 복호화합니다.
