# KICASecureKeypad 라이브러리 분석

이 문서는 `kicasecurekeypad` 라이브러리의 구조와 동작 원리를 설명합니다.

---

## 1. 전체 구조 (Architecture)

**MVVM 패턴 + Jetpack Compose** 기반

```
┌─────────────────────────────────────────────────────────┐
│                      SecureKeypad                        │
│  (Composable - View)                                    │
├─────────────────────────────────────────────────────────┤
│                    KeypadViewModel                       │
│  (상태 관리, 비즈니스 로직, 검증)                         │
├─────────────────────────────────────────────────────────┤
│  KeyDataManager     │  HangulAssembler  │  Layouts      │
│  (암호화/키관리)     │  (한글 조합)       │  (키배치)     │
├─────────────────────────────────────────────────────────┤
│  AESHelper  │  RSAHelper  │  MACHelper  │  KeyManager   │
│  (보안 모듈)                                             │
└─────────────────────────────────────────────────────────┘
```

---

## 2. 주요 파일 구조

### 2.1. View Layer

| 파일 | 역할 |
|------|------|
| `SecureKeypad.kt` | 메인 Composable, 모든 기능의 진입점 |
| `ui/KeypadButton.kt` | 개별 키 버튼 UI |
| `ui/KeypadHeader.kt` | 상단 헤더 (제목, 부제목, 취소 버튼) |
| `ui/InputDisplay.kt` | 입력 인디케이터 (DOT, BOX, UNDERLINE, TEXT) |

### 2.2. ViewModel Layer

| 파일 | 역할 |
|------|------|
| `KeypadViewModel.kt` | 상태 관리, 키 입력 처리, 검증 로직 |

**주요 StateFlow:**
- `maskedInput`: 마스킹된 입력값 (`●●●`)
- `keys`: 현재 표시할 키 목록
- `currentLanguage`: 현재 언어 모드 (한글/영문)
- `isSpecialCharMode`: 특수문자 모드 여부
- `validationResult`: 입력 검증 결과

### 2.3. Data Layer

| 폴더/파일 | 역할 |
|----------|------|
| `data/layout/EnglishLayout.kt` | 영문 QWERTY 배열 |
| `data/layout/KoreanLayout.kt` | 한글 자판 배열 |
| `data/layout/SpecialCharLayout.kt` | 특수문자 배열 |
| `data/layout/NumericLayout.kt` | 숫자 키패드 (랜덤 지원) |

### 2.4. Domain Model

| 파일 | 역할 |
|------|------|
| `Key.kt` | 키 데이터 (value, displayText, type) |
| `KeyType.kt` | 키 종류 (NORMAL, BACKSPACE, SHIFT, etc.) |
| `KeypadConfig.kt` | 키패드 설정 (모든 옵션 포함) |
| `KeypadColors.kt` | 색상 테마 (`kica()`, `dark()`, `lavender()`) |
| `KeypadDisplayMode.kt` | 표시 모드 (FULL, HALF, COMPACT) |
| `InputIndicatorStyle.kt` | 인디케이터 스타일 (DOT, BOX, UNDERLINE, TEXT) |
| `InputValidation.kt` | 검증 규칙 (minLength, maxLength, regex, customValidator) |

### 2.5. Security Layer

| 파일 | 역할 |
|------|------|
| `KeyDataManager.kt` | 암호화 데이터 관리, 메모리 보안 |
| `AESHelper.kt` | AES-256/CBC 암호화 |
| `RSAHelper.kt` | RSA-2048 키 암호화 |
| `MACHelper.kt` | HMAC-SHA1 무결성 검증 |
| `KeyManager.kt` | 키 생성 및 관리 |

### 2.6. Utils

| 파일 | 역할 |
|------|------|
| `HangulAssembler.kt` | 한글 자모 조합 처리 |
| `Extensions.kt` | Context 확장 함수 (findActivity 등) |

---

## 3. 데이터 흐름

### 3.1. 키 입력 흐름

```
사용자 → KeypadButton.onClick
       → ViewModel.handleKeyPress(key)
       → 키 타입별 처리:
           ├─ NORMAL → handleNormalKey() → inputBuffer 추가
           ├─ BACKSPACE → handleBackspace() → 마지막 문자 삭제
           ├─ SHIFT → toggleShift() → 대소문자 전환
           ├─ SWITCH → toggleLanguage() → 한/영 전환
           └─ COMPLETE → onComplete 콜백 호출
       → validateInput() → 검증 결과 업데이트
       → updateMaskedDisplay() → UI 갱신
```

### 3.2. 암호화 흐름 (enableEncryption = true)

```
키 입력 → keyDataManager.appendCharacter(char)
       → AES-256 암호화 (랜덤 패딩 포함)
       → 암호화 블록 저장
       
완료 시 → keyDataManager.getFinalEncryptedData()
       ├─ 1. 암호화 블록 병합
       ├─ 2. 대칭키 RSA 암호화
       ├─ 3. HMAC-SHA1 서명 생성
       └─ 4. Hex 문자열 반환
```

---

## 4. KeypadConfig 옵션 전체

### 기본 설정
| 옵션 | 타입 | 기본값 |
|------|------|--------|
| `type` | `KeypadType` | `NUMERIC` |
| `maxLength` | `Int` | 20 |
| `maskingChar` | `Char` | `*` |
| `randomizeLayout` | `Boolean` | `true` |
| `enableEncryption` | `Boolean` | `false` |
| `enableHapticFeedback` | `Boolean` | `true` |
| `preventScreenCapture` | `Boolean` | `true` |

### UI 설정
| 옵션 | 타입 | 기본값 |
|------|------|--------|
| `title` | `String?` | `null` |
| `subtitle` | `String?` | `null` |
| `showCancelButton` | `Boolean` | `false` |
| `cancelButtonText` | `String` | `"취소"` |
| `displayMode` | `KeypadDisplayMode` | `HALF` |
| `inputIndicatorStyle` | `InputIndicatorStyle` | `DOT` |
| `showFixedInputSlots` | `Boolean` | `false` |
| `colors` | `KeypadColors` | `default()` |

### 검증 설정
| 옵션 | 타입 | 기본값 |
|------|------|--------|
| `validation.minLength` | `Int?` | `null` |
| `validation.maxLength` | `Int?` | `null` |
| `validation.regex` | `String?` | `null` |
| `validation.customValidator` | `(String) -> String?` | `null` |

---

## 5. 콜백 이벤트

### 기본 콜백
| 콜백 | 시점 |
|------|------|
| `onKeyPressed` | 키 입력마다 (마스킹값 전달) |
| `onComplete` | 완료 버튼 클릭 |
| `onCancel` | 취소 버튼 클릭 |
| `onError` | 에러 발생 |

### 확장 콜백
| 콜백 | 시점 |
|------|------|
| `onShow` | 키패드 표시 |
| `onHide` | 키패드 사라짐 |
| `onBackspace` | 삭제 키 클릭 |
| `onClear` | 전체 삭제 |

---

## 6. 색상 테마

### 기본 제공 테마
- `KeypadColors.default()` - 기본 (다크모드 자동 전환)
- `KeypadColors.dark()` - 다크 테마
- `KeypadColors.kica()` - KICA 스타일 (라이트)
- `KeypadColors.lavender()` - 연보라 테마

### 커스텀 색상 속성
| 속성 | 설명 |
|------|------|
| `backgroundColor` | 전체 배경색 |
| `keyBackgroundColor` | 일반 키 배경 |
| `keyTextColor` | 일반 키 텍스트 |
| `specialKeyBackgroundColor` | 특수 키 배경 |
| `specialKeyTextColor` | 특수 키 텍스트 |
| `inputDisplayBackgroundColor` | 인디케이터 배경 |
| `inputDisplayTextColor` | 인디케이터 텍스트 |
| `titleColor` | 제목 색상 |
| `subtitleColor` | 부제목 색상 |
| `cancelButtonColor` | 취소 버튼 색상 |

---

## 7. 메모리 보안

### 자동 정리
- 키패드 종료 시 `clearInput()` 자동 호출
- `inputBuffer` 제로화 후 클리어

### 수동 보안 정리
```kotlin
// 세션 종료 시 호출
viewModel.secureClearInput()

// KeyDataManager 레벨
keyDataManager.secureClear()  // 대칭키, 암호화 블록 모두 제로화
```

---

## 8. 커스터마이징 가이드

### 키 배열 수정
`data/layout/` 폴더의 `getKeys()` 함수 수정

### 새 기능 키 추가
1. `KeyType.kt`에 새 타입 추가
2. Layout 파일에 키 추가
3. `KeypadViewModel.handleKeyPress`에 처리 로직 추가

### 새 색상 테마 추가
`KeypadColors.kt` companion object에 새 함수 추가
